<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>U.S. States & Capitals Quiz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style id="app-style">
    .theme-playful {
      --primary-color: #FF9E44;
      --secondary-color: #5B9BD5;
      --accent-color: #FF5252;
      --background-color: #FFFFE0;
      --text-color: #333333;
      --button-color: #6ECB63;
      --button-hover: #4CAF50;
      --correct-color: #66BB6A;
      --incorrect-color: #FF5252;
      --panel-bg: #FFF9C4;
      --toggle-bg: #FFB74D;
      --toggle-active: #FF9800;
      font-family: 'Comic Sans MS', cursive, sans-serif;
    }

    .theme-modern {
      --primary-color: #3498db;
      --secondary-color: #2c3e50;
      --accent-color: #e74c3c;
      --background-color: #f5f5f5;
      --text-color: #2c3e50;
      --button-color: #3498db;
      --button-hover: #2980b9;
      --correct-color: #2ecc71;
      --incorrect-color: #e74c3c;
      --panel-bg: #ffffff;
      --toggle-bg: #bdc3c7;
      --toggle-active: #3498db;
      font-family: 'Roboto', sans-serif;
    }

    .theme-minimalist {
      --primary-color: #555555;
      --secondary-color: #333333;
      --accent-color: #777777;
      --background-color: #ffffff;
      --text-color: #333333;
      --button-color: #dddddd;
      --button-hover: #cccccc;
      --correct-color: #4caf50;
      --incorrect-color: #f44336;
      --panel-bg: #f9f9f9;
      --toggle-bg: #e0e0e0;
      --toggle-active: #bbbbbb;
      font-family: 'Arial', sans-serif;
    }

    body {
      background-color: var(--background-color);
      color: var(--text-color);
      transition: all 0.3s ease;
    }

    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--toggle-bg);
      transition: .4s;
      border-radius: 34px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .toggle-slider {
      background-color: var(--toggle-active);
    }

    input:checked + .toggle-slider:before {
      transform: translateX(30px);
    }

    .checkbox-custom {
      display: flex;
      align-items: center;
    }
    
    .checkbox-custom input[type="checkbox"] {
      accent-color: var(--primary-color);
      width: 16px;
      height: 16px;
    }

    .btn-mode {
      background-color: var(--button-color);
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn-mode:hover {
      background-color: var(--button-hover);
      transform: translateY(-2px);
    }

    .btn-mode.active {
      background-color: var(--secondary-color);
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }

    .state-path {
      fill: #DDDDDD;
      stroke: white;
      stroke-width: 1;
      transition: all 0.2s;
      cursor: pointer;
    }

    .state-path.enabled {
      fill: var(--secondary-color);
      opacity: 0.7;
    }

    .state-path.enabled:hover {
      opacity: 0.9;
      stroke-width: 2;
    }

    .capital-marker {
      fill: var(--accent-color);
      cursor: pointer;
      transition: all 0.2s;
    }

    .capital-marker.enabled {
      opacity: 1;
    }

    .capital-marker.enabled:hover {
      transform: scale(1.5);
    }

    .capital-marker.disabled {
      opacity: 0.2;
    }

    .choice-btn {
      background-color: var(--primary-color);
      color: white;
      padding: 12px;
      border-radius: 8px;
      font-weight: bold;
      transition: all 0.3s;
      margin: 8px;
      min-width: 200px;
    }

    .choice-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .choice-btn.correct {
      background-color: var(--correct-color);
      animation: pulse 0.5s;
    }

    .choice-btn.incorrect {
      background-color: var(--incorrect-color);
      animation: shake 0.5s;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .settings-button {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--secondary-color);
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: all 0.3s;
      z-index: 1000;
    }

    .settings-button:hover {
      transform: rotate(30deg);
    }

    .settings-panel {
      position: fixed;
      bottom: 80px;
      right: 20px;
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      z-index: 999;
      display: none;
    }

    .theme-option {
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .theme-option:hover {
      background-color: #f0f0f0;
    }

    .collapse-button {
      cursor: pointer;
      transition: transform 0.3s;
    }

    .rotate-180 {
      transform: rotate(180deg);
    }

    .states-list {
      max-height: 400px;
      overflow-y: auto;
      transition: max-height 0.3s ease;
    }

    .states-list.collapsed {
      max-height: 0;
      overflow: hidden;
    }

    /* Custom scrollbar */
    .states-list::-webkit-scrollbar {
      width: 8px;
    }

    .states-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    .states-list::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 10px;
    }

    .states-list::-webkit-scrollbar-thumb:hover {
      background: var(--secondary-color);
    }

    /* Map container */
    .map-container {
      position: relative;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }

    #us-map {
      width: 100%;
      height: auto;
    }

    /* Loader */
    .loader {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Try again tooltip */
    .tooltip {
      position: absolute;
      background-color: var(--incorrect-color);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 14px;
      z-index: 100;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .tooltip.visible {
      opacity: 1;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        max-width: 100%;
      }
      
      .quiz-container {
        width: 100%;
      }
      
      .choice-btn {
        min-width: 100%;
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="theme-playful">
  <div class="container mx-auto px-4 py-6">
    <h1 class="text-4xl font-bold text-center mb-6">U.S. States & Capitals Quiz</h1>
    
    <div class="main-container flex flex-wrap">
      <!-- Left sidebar -->
      <div class="sidebar w-full md:w-1/3 p-4">
        <div class="bg-white rounded-lg shadow-lg p-4" style="background-color: var(--panel-bg)">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Quiz Settings</h2>
            <div class="flex items-center">
              <span class="mr-2">States</span>
              <label class="toggle-switch">
                <input type="checkbox" id="quiz-type-toggle">
                <span class="toggle-slider"></span>
              </label>
              <span class="ml-2">Capitals</span>
            </div>
          </div>
          
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Select States</h3>
            <div class="flex">
              <button id="select-all" class="text-sm mr-2 px-2 py-1 rounded" style="background-color: var(--button-color); color: white;">Select All</button>
              <button id="deselect-all" class="text-sm px-2 py-1 rounded" style="background-color: var(--button-color); color: white;">Deselect All</button>
            </div>
          </div>
          
          <div class="flex justify-between items-center mb-2 cursor-pointer" id="collapse-toggle">
            <span class="font-semibold">States List</span>
            <i class="fas fa-chevron-down collapse-button"></i>
          </div>
          
          <div class="states-list" id="states-list">
            <!-- States checkboxes will be dynamically populated -->
            <div class="loader" id="states-loader"></div>
          </div>
        </div>
      </div>
      
      <!-- Right quiz area -->
      <div class="quiz-container w-full md:w-2/3 p-4">
        <div class="bg-white rounded-lg shadow-lg p-4 h-full" style="background-color: var(--panel-bg)">
          <!-- Quiz mode selection -->
          <div class="flex justify-center mb-4 gap-4">
            <button id="map-mode" class="btn-mode active">
              <i class="fas fa-map-marked-alt mr-2"></i> Map Click
            </button>
            <button id="multiple-choice-mode" class="btn-mode">
              <i class="fas fa-list-ol mr-2"></i> Multiple Choice
            </button>
          </div>
          
          <!-- Score display -->
          <div class="flex justify-center mb-4 text-lg font-bold">
            <span>Attempts: <span id="attempts-counter">0</span> | </span>
            <span class="ml-2">Correct: <span id="correct-counter">0</span>/<span id="total-counter">0</span></span>
            <button id="reset-quiz" class="ml-4 px-3 py-1 rounded text-sm" style="background-color: var(--accent-color); color: white;">
              <i class="fas fa-redo-alt mr-1"></i> Reset
            </button>
          </div>
          
          <!-- Map quiz mode -->
          <div id="map-quiz-container" class="h-[500px] flex items-center justify-center">
            <div class="map-container">
              <div id="us-map-container" class="w-full h-full relative">
                <div class="loader" id="map-loader"></div>
                <svg id="us-map" preserveAspectRatio="xMidYMid meet" viewBox="0 0 959 593"></svg>
                <div class="tooltip" id="map-tooltip">Incorrect. Try again!</div>
              </div>
            </div>
          </div>
          
          <!-- Multiple choice quiz mode (initially hidden) -->
          <div id="multiple-choice-container" class="flex flex-col items-center h-[500px] hidden">
            <div class="text-2xl font-bold mb-6 text-center" id="quiz-prompt">Loading question...</div>
            <div id="choices-container" class="flex flex-wrap justify-center">
              <!-- Choices will be dynamically added here -->
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Settings button -->
    <div class="settings-button" id="settings-button">
      <i class="fas fa-cog fa-lg"></i>
    </div>
    
    <!-- Settings panel -->
    <div class="settings-panel" id="settings-panel">
      <h3 class="text-lg font-bold mb-3">Theme Settings</h3>
      <div class="theme-option" data-theme="playful">
        <i class="fas fa-paint-brush mr-2"></i> Playful Cartoonish
      </div>
      <div class="theme-option" data-theme="modern">
        <i class="fas fa-paint-brush mr-2"></i> Modern Flat
      </div>
      <div class="theme-option" data-theme="minimalist">
        <i class="fas fa-paint-brush mr-2"></i> Minimalist
      </div>
    </div>
  </div>

  <script id="app-script">
    // US States and Capitals Data
    const statesData = [
      { id: "AL", name: "Alabama", capital: "Montgomery" },
      { id: "AK", name: "Alaska", capital: "Juneau" },
      { id: "AZ", name: "Arizona", capital: "Phoenix" },
      { id: "AR", name: "Arkansas", capital: "Little Rock" },
      { id: "CA", name: "California", capital: "Sacramento" },
      { id: "CO", name: "Colorado", capital: "Denver" },
      { id: "CT", name: "Connecticut", capital: "Hartford" },
      { id: "DE", name: "Delaware", capital: "Dover" },
      { id: "FL", name: "Florida", capital: "Tallahassee" },
      { id: "GA", name: "Georgia", capital: "Atlanta" },
      { id: "HI", name: "Hawaii", capital: "Honolulu" },
      { id: "ID", name: "Idaho", capital: "Boise" },
      { id: "IL", name: "Illinois", capital: "Springfield" },
      { id: "IN", name: "Indiana", capital: "Indianapolis" },
      { id: "IA", name: "Iowa", capital: "Des Moines" },
      { id: "KS", name: "Kansas", capital: "Topeka" },
      { id: "KY", name: "Kentucky", capital: "Frankfort" },
      { id: "LA", name: "Louisiana", capital: "Baton Rouge" },
      { id: "ME", name: "Maine", capital: "Augusta" },
      { id: "MD", name: "Maryland", capital: "Annapolis" },
      { id: "MA", name: "Massachusetts", capital: "Boston" },
      { id: "MI", name: "Michigan", capital: "Lansing" },
      { id: "MN", name: "Minnesota", capital: "St. Paul" },
      { id: "MS", name: "Mississippi", capital: "Jackson" },
      { id: "MO", name: "Missouri", capital: "Jefferson City" },
      { id: "MT", name: "Montana", capital: "Helena" },
      { id: "NE", name: "Nebraska", capital: "Lincoln" },
      { id: "NV", name: "Nevada", capital: "Carson City" },
      { id: "NH", name: "New Hampshire", capital: "Concord" },
      { id: "NJ", name: "New Jersey", capital: "Trenton" },
      { id: "NM", name: "New Mexico", capital: "Santa Fe" },
      { id: "NY", name: "New York", capital: "Albany" },
      { id: "NC", name: "North Carolina", capital: "Raleigh" },
      { id: "ND", name: "North Dakota", capital: "Bismarck" },
      { id: "OH", name: "Ohio", capital: "Columbus" },
      { id: "OK", name: "Oklahoma", capital: "Oklahoma City" },
      { id: "OR", name: "Oregon", capital: "Salem" },
      { id: "PA", name: "Pennsylvania", capital: "Harrisburg" },
      { id: "RI", name: "Rhode Island", capital: "Providence" },
      { id: "SC", name: "South Carolina", capital: "Columbia" },
      { id: "SD", name: "South Dakota", capital: "Pierre" },
      { id: "TN", name: "Tennessee", capital: "Nashville" },
      { id: "TX", name: "Texas", capital: "Austin" },
      { id: "UT", name: "Utah", capital: "Salt Lake City" },
      { id: "VT", name: "Vermont", capital: "Montpelier" },
      { id: "VA", name: "Virginia", capital: "Richmond" },
      { id: "WA", name: "Washington", capital: "Olympia" },
      { id: "WV", name: "West Virginia", capital: "Charleston" },
      { id: "WI", name: "Wisconsin", capital: "Madison" },
      { id: "WY", name: "Wyoming", capital: "Cheyenne" }
    ];
    
    // Capital coordinates for map display - simplified for prototype
    const capitalCoordinates = {};
    
    // App state
    const appState = {
      quizType: "states", // "states" or "capitals"
      quizMode: "map", // "map" or "multipleChoice"
      enabledStates: {},
      currentQuestion: null,
      currentChoices: [],
      attempts: 0,
      correct: 0,
      total: 0,
      activeState: null
    };
    
    // Load state from localStorage if available
    function loadStateFromStorage() {
      try {
        const savedState = localStorage.getItem('usQuizAppState');
        if (savedState) {
          const parsedState = JSON.parse(savedState);
          
          // Apply theme
          if (parsedState.theme) {
            setTheme(parsedState.theme);
          }
          
          // Apply quiz type
          if (parsedState.quizType) {
            appState.quizType = parsedState.quizType;
            $('#quiz-type-toggle').prop('checked', parsedState.quizType === 'capitals');
          }
          
          // Apply quiz mode
          if (parsedState.quizMode) {
            appState.quizMode = parsedState.quizMode;
            updateQuizModeUI();
          }
          
          // Apply enabled states
          if (parsedState.enabledStates) {
            appState.enabledStates = parsedState.enabledStates;
          } else {
            // Default: enable all states
            statesData.forEach(state => {
              appState.enabledStates[state.id] = true;
            });
          }
          
          // Apply counters
          if (parsedState.attempts !== undefined) appState.attempts = parsedState.attempts;
          if (parsedState.correct !== undefined) appState.correct = parsedState.correct;
          
          updateCounters();
        } else {
          // Default: enable all states
          statesData.forEach(state => {
            appState.enabledStates[state.id] = true;
          });
        }
      } catch (e) {
        console.error('Error loading state from storage:', e);
        // Default: enable all states
        statesData.forEach(state => {
          appState.enabledStates[state.id] = true;
        });
      }
    }
    
    // Save state to localStorage
    function saveStateToStorage() {
      try {
        const stateToSave = {
          theme: $('body').attr('class'),
          quizType: appState.quizType,
          quizMode: appState.quizMode,
          enabledStates: appState.enabledStates,
          attempts: appState.attempts,
          correct: appState.correct
        };
        localStorage.setItem('usQuizAppState', JSON.stringify(stateToSave));
      } catch (e) {
        console.error('Error saving state to storage:', e);
      }
    }
    
    // Initialize states list
    function initStatesListUI() {
      $('#states-loader').hide();
      const $statesList = $('#states-list');
      
      statesData.forEach(state => {
        const isChecked = appState.enabledStates[state.id] === true;
        const $checkbox = $(`
          <div class="checkbox-custom py-1">
            <input type="checkbox" id="state-${state.id}" 
                   data-state-id="${state.id}" 
                   class="state-checkbox mr-2" 
                   ${isChecked ? 'checked' : ''}>
            <label for="state-${state.id}">${state.name}</label>
          </div>
        `);
        $statesList.append($checkbox);
      });
      
      // Event listener for state checkboxes
      $('.state-checkbox').on('change', function() {
        const stateId = $(this).data('state-id');
        appState.enabledStates[stateId] = $(this).is(':checked');
        
        updateMap();
        updateCounters();
        saveStateToStorage();
        
        if (appState.quizMode === 'multipleChoice') {
          startMultipleChoiceQuiz();
        }
      });
    }
    
    // Update counters display
    function updateCounters() {
      const enabledCount = Object.values(appState.enabledStates).filter(val => val === true).length;
      appState.total = enabledCount;
      
      $('#attempts-counter').text(appState.attempts);
      $('#correct-counter').text(appState.correct);
      $('#total-counter').text(appState.total);
    }
    
    // Load US map data (using D3.js)
    function loadUsMap() {
      // For the prototype, use a sample geoJSON URL - in real app, would use actual geoJSON file
      d3.json("https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json").then(us => {
        $('#map-loader').hide();
        
        // Convert TopoJSON to GeoJSON
        const states = topojson.feature(us, us.objects.states).features;
        
        // Create map
        const svg = d3.select("#us-map");
        
        // Draw states
        svg.selectAll("path")
          .data(states)
          .enter()
          .append("path")
          .attr("class", d => {
            const stateData = statesData.find(state => state.id === d.properties.postal);
            return `state-path ${stateData && appState.enabledStates[stateData.id] ? 'enabled' : ''}`;
          })
          .attr("data-state-id", d => d.properties.postal)
          .attr("d", d3.geoPath())
          .on("click", function(event, d) {
            if (appState.quizMode === 'map' && appState.quizType === 'states') {
              const stateId = d.properties.postal;
              if (appState.enabledStates[stateId]) {
                handleMapQuizAnswer(stateId);
              }
            }
          });
        
        // Add capitals (simplified for prototype - real app would use actual coordinates)
        svg.append("g")
          .selectAll("circle")
          .data(statesData)
          .enter()
          .append("circle")
          .attr("class", d => `capital-marker ${appState.enabledStates[d.id] ? 'enabled' : 'disabled'}`)
          .attr("data-capital", d => d.capital)
          .attr("data-state-id", d => d.id)
          .attr("cx", (d, i) => 100 + (i % 10) * 80) // Simplified positions for prototype
          .attr("cy", (d, i) => 100 + Math.floor(i / 10) * 80) // Simplified positions for prototype
          .attr("r", 5)
          .style("display", appState.quizType === 'capitals' ? 'block' : 'none')
          .on("click", function(event, d) {
            if (appState.quizMode === 'map' && appState.quizType === 'capitals') {
              if (appState.enabledStates[d.id]) {
                handleMapQuizAnswer(d.id);
              }
            }
          });
        
        // Set up initial quiz state
        updateMap();
        if (appState.quizMode === 'map') {
          setupMapQuiz();
        }
      }).catch(error => {
        console.error('Error loading map:', error);
        $('#map-loader').hide();
        $('#us-map-container').html('<div class="text-center text-red-500">Error loading map. <button class="text-blue-500 underline" onclick="location.reload()">Retry</button></div>');
      });
    }
    
    // Update map based on enabled states
    function updateMap() {
      d3.selectAll(".state-path")
        .attr("class", function() {
          const stateId = d3.select(this).attr("data-state-id");
          return `state-path ${appState.enabledStates[stateId] ? 'enabled' : ''}`;
        });
      
      d3.selectAll(".capital-marker")
        .attr("class", function() {
          const stateId = d3.select(this).attr("data-state-id");
          return `capital-marker ${appState.enabledStates[stateId] ? 'enabled' : 'disabled'}`;
        })
        .style("display", appState.quizType === 'capitals' ? 'block' : 'none');
    }
    
    // Set up map quiz
    function setupMapQuiz() {
      // Get list of enabled states
      const enabledStates = statesData.filter(state => appState.enabledStates[state.id]);
      
      if (enabledStates.length === 0) {
        Swal.fire({
          title: 'No states selected',
          text: 'Please select at least one state to start the quiz.',
          icon: 'warning',
          confirmButtonColor: 'var(--primary-color)'
        });
        return;
      }
      
      // Select a random state
      const randomIndex = Math.floor(Math.random() * enabledStates.length);
      appState.activeState = enabledStates[randomIndex];
      
      // Update prompt based on quiz type
      if (appState.quizType === 'states') {
        // Highlight capital, ask for state
        Swal.fire({
          title: 'Map Quiz',
          text: `Click on the state where ${appState.activeState.capital} is the capital.`,
          confirmButtonColor: 'var(--primary-color)'
        });
      } else {
        // Highlight state, ask for capital
        Swal.fire({
          title: 'Map Quiz',
          text: `Click on the capital of ${appState.activeState.name}.`,
          confirmButtonColor: 'var(--primary-color)'
        });
      }
    }
    
    // Handle map quiz answers
    function handleMapQuizAnswer(answerId) {
      appState.attempts++;
      
      if (answerId === appState.activeState.id) {
        // Correct answer
        appState.correct++;
        
        // Flash green
        if (appState.quizType === 'states') {
          d3.select(`path[data-state-id="${answerId}"]`)
            .style("fill", "var(--correct-color)")
            .transition()
            .duration(1000)
            .style("fill", null);
        } else {
          d3.select(`circle[data-state-id="${answerId}"]`)
            .style("fill", "var(--correct-color)")
            .transition()
            .duration(1000)
            .style("fill", null);
        }
        
        // Update counters
        updateCounters();
        saveStateToStorage();
        
        // Move to next question after a brief pause
        setTimeout(() => {
          setupMapQuiz();
        }, 1000);
      } else {
        // Incorrect answer
        
        // Flash red
        if (appState.quizType === 'states') {
          d3.select(`path[data-state-id="${answerId}"]`)
            .style("fill", "var(--incorrect-color)")
            .transition()
            .duration(1000)
            .style("fill", null);
        } else {
          d3.select(`circle[data-state-id="${answerId}"]`)
            .style("fill", "var(--incorrect-color)")
            .transition()
            .duration(1000)
            .style("fill", null);
        }
        
        // Show tooltip
        const tooltip = $('#map-tooltip');
        tooltip.addClass('visible');
        
        // Position tooltip near mouse
        tooltip.css({
          top: d3.pointer(event)[1] + 'px',
          left: d3.pointer(event)[0] + 'px'
        });
        
        // Hide tooltip after a delay
        setTimeout(() => {
          tooltip.removeClass('visible');
        }, 2000);
        
        // Update counters
        updateCounters();
        saveStateToStorage();
      }
    }
    
    // Start multiple choice quiz
    function startMultipleChoiceQuiz() {
      // Get list of enabled states
      const enabledStates = statesData.filter(state => appState.enabledStates[state.id]);
      
      if (enabledStates.length < 4) {
        $('#quiz-prompt').text('Please select at least 4 states to start the multiple choice quiz.');
        $('#choices-container').empty();
        return;
      }
      
      // Select a random state for the question
      const randomIndex = Math.floor(Math.random() * enabledStates.length);
      appState.activeState = enabledStates[randomIndex];
      
      // Generate choices
      let choices = [appState.activeState];
      
      // Add 3 more random states that are different from the correct answer
      while (choices.length < 4) {
        const randomState = enabledStates[Math.floor(Math.random() * enabledStates.length)];
        if (!choices.includes(randomState)) {
          choices.push(randomState);
        }
      }
      
      // Shuffle choices
      choices = shuffleArray(choices);
      
      // Update UI
      if (appState.quizType === 'states') {
        $('#quiz-prompt').text(`What state has ${appState.activeState.capital} as its capital?`);
      } else {
        $('#quiz-prompt').text(`What is the capital of ${appState.activeState.name}?`);
      }
      
      // Add choice buttons
      $('#choices-container').empty();
      choices.forEach(state => {
        const buttonText = appState.quizType === 'states' ? state.name : state.capital;
        const $button = $(`<button class="choice-btn" data-state-id="${state.id}">${buttonText}</button>`);
        $('#choices-container').append($button);
      });
      
      // Add event listeners to choice buttons
      $('.choice-btn').on('click', function() {
        const selectedStateId = $(this).data('state-id');
        handleMultipleChoiceAnswer(selectedStateId);
      });
    }
    
    // Handle multiple choice answers
    function handleMultipleChoiceAnswer(answerId) {
      appState.attempts++;
      
      if (answerId === appState.activeState.id) {
        // Correct answer
        appState.correct++;
        
        // Update button appearance
        $(`.choice-btn[data-state-id="${answerId}"]`).addClass('correct');
        
        // Update counters
        updateCounters();
        saveStateToStorage();
        
        // Move to next question after a brief pause
        setTimeout(() => {
          startMultipleChoiceQuiz();
        }, 1000);
      } else {
        // Incorrect answer
        
        // Update button appearance
        $(`.choice-btn[data-state-id="${answerId}"]`).addClass('incorrect');
        
        // Remove class after animation completes
        setTimeout(() => {
          $(`.choice-btn[data-state-id="${answerId}"]`).removeClass('incorrect');
        }, 500);
        
        // Update counters
        updateCounters();
        saveStateToStorage();
      }
    }
    
    // Helper function to shuffle array
    function shuffleArray(array) {
      let currentIndex = array.length, randomIndex;
      
      while (currentIndex != 0) {
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
        
        [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
      }
      
      return array;
    }
    
    // Set theme
    function setTheme(theme) {
      $('body').attr('class', theme);
      saveStateToStorage();
    }
    
    // Update quiz mode UI
    function updateQuizModeUI() {
      if (appState.quizMode === 'map') {
        $('#map-mode').addClass('active');
        $('#multiple-choice-mode').removeClass('active');
        $('#map-quiz-container').show();
        $('#multiple-choice-container').hide();
        setupMapQuiz();
      } else {
        $('#map-mode').removeClass('active');
        $('#multiple-choice-mode').addClass('active');
        $('#map-quiz-container').hide();
        $('#multiple-choice-container').show();
        startMultipleChoiceQuiz();
      }
    }
    
    // Reset quiz
    function resetQuiz() {
      appState.attempts = 0;
      appState.correct = 0;
      updateCounters();
      saveStateToStorage();
      
      if (appState.quizMode === 'map') {
        setupMapQuiz();
      } else {
        startMultipleChoiceQuiz();
      }
    }
    
    // Document ready
    $(document).ready(function() {
      // Load saved state
      loadStateFromStorage();
      
      // Initialize states list
      initStatesListUI();
      
      // Load US map
      loadUsMap();
      
      // Event listener for quiz type toggle
      $('#quiz-type-toggle').on('change', function() {
        appState.quizType = $(this).is(':checked') ? 'capitals' : 'states';
        updateMap();
        
        if (appState.quizMode === 'map') {
          setupMapQuiz();
        } else {
          startMultipleChoiceQuiz();
        }
        
        saveStateToStorage();
      });
      
      // Event listener for mode buttons
      $('#map-mode').on('click', function() {
        appState.quizMode = 'map';
        updateQuizModeUI();
        saveStateToStorage();
      });
      
      $('#multiple-choice-mode').on('click', function() {
        appState.quizMode = 'multipleChoice';
        updateQuizModeUI();
        saveStateToStorage();
      });
      
      // Event listener for select/deselect all
      $('#select-all').on('click', function() {
        $('.state-checkbox').prop('checked', true);
        statesData.forEach(state => {
          appState.enabledStates[state.id] = true;
        });
        updateMap();
        updateCounters();
        saveStateToStorage();
        
        if (appState.quizMode === 'multipleChoice') {
          startMultipleChoiceQuiz();
        }
      });
      
      $('#deselect-all').on('click', function() {
        $('.state-checkbox').prop('checked', false);
        statesData.forEach(state => {
          appState.enabledStates[state.id] = false;
        });
        updateMap();
        updateCounters();
        saveStateToStorage();
        
        if (appState.quizMode === 'multipleChoice') {
          startMultipleChoiceQuiz();
        }
      });
      
      // Event listener for reset button
      $('#reset-quiz').on('click', function() {
        resetQuiz();
      });
      
      // Event listener for collapsing states list
      $('#collapse-toggle').on('click', function() {
        $('#states-list').toggleClass('collapsed');
        $('.collapse-button').toggleClass('rotate-180');
      });
      
      // Settings panel
      $('#settings-button').on('click', function() {
        $('#settings-panel').toggle();
      });
      
      // Theme options
      $('.theme-option').on('click', function() {
        const theme = $(this).data('theme');
        setTheme(`theme-${theme}`);
        $('#settings-panel').hide();
      });
      
      // Close settings panel when clicking outside
      $(document).on('click', function(event) {
        if (!$(event.target).closest('#settings-panel').length && 
            !$(event.target).closest('#settings-button').length) {
          $('#settings-panel').hide();
        }
      });
      
      // Initialize based on current quiz mode
      updateQuizModeUI();
    });
  </script>

</body>
</html>
